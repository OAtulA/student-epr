// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teacher Teacher?
  student Student?

  @@map("users")
}

model Teacher {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  teacherId   String    @unique
  name        String
  joiningDate DateTime
  leavingDate DateTime?
  userId      String    @unique @db.ObjectId
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  subjects TeacherSubject[]

  @@map("teachers")
}

model Student {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  enrollNo   String @unique
  name       String
  batch      String // "2022-2026"
  discipline String // CSE, IT, ECE, EEE, ML, DS
  userId     String @unique @db.ObjectId
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  marks  Marks[]
  advice Advice[]

  @@map("students")
}

model Discipline {
  id       String    @id @default(auto()) @map("_id") @db.ObjectId
  name     String    @unique // CSE, IT, ECE, EEE, ML, DS
  subjects Subject[]

  @@map("disciplines")
}

model Subject {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  code          String
  name          String
  semester      Int
  batch         String   @default("2022-2026")
  disciplineId  String   @db.ObjectId
  discipline    Discipline @relation(fields: [disciplineId], references: [id])

  teacherSubjects TeacherSubject[]
  marks           Marks[]
  advice          Advice[]

  @@unique([code, disciplineId, semester, batch])

  @@map("subjects")
}


model TeacherSubject {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  teacherId String @db.ObjectId
  subjectId String @db.ObjectId
  batch     String // "2022-2026"
  startRoll Int // Starting roll number range
  endRoll   Int // Ending roll number range

  teacher Teacher @relation(fields: [teacherId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])
  marks   Marks[]

  @@unique([teacherId, subjectId, batch, startRoll, endRoll])
  @@map("teacher_subjects")
}

model Marks {
  id               String @id @default(auto()) @map("_id") @db.ObjectId
  studentId        String @db.ObjectId
  teacherSubjectId String @db.ObjectId
  midSem           Float? // Mid semester marks
  endSem           Float? // End semester marks
  internal         Float? // Internal assessment marks
  total            Float? // Calculated total

  student        Student        @relation(fields: [studentId], references: [id])
  teacherSubject TeacherSubject @relation(fields: [teacherSubjectId], references: [id])
  subject        Subject?       @relation(fields: [subjectId], references: [id])
  subjectId      String?        @db.ObjectId

  @@unique([studentId, teacherSubjectId])
  @@map("marks")
}

model Advice {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  subjectId String?  @db.ObjectId
  advice    String
  isGeneral Boolean  @default(false)
  createdAt DateTime @default(now())

  student Student  @relation(fields: [studentId], references: [id])
  subject Subject? @relation(fields: [subjectId], references: [id])

  @@map("advice")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}
